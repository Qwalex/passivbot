## Архитектура Passivbot

Это высокоуровневый обзор устройства приложения: какие есть компоненты, как они взаимодействуют и где искать логику.

### Ключевые идеи
- Контртрендовая сеточная торговля на бессрочных фьючерсах (perpetuals)
- «Малый первый вход» + управляемые усреднения + ТП‑сетка/трейлинг‑закрытия
- Forager‑режим выбора самых «шумных» инструментов
- Жёсткие лимиты экспозиции (WE) и процедуры «разморозки» (unstuck)
- Бэктест и оптимизатор (NSGA‑II) для подбора параметров
- Узкие места вынесены в Rust для скорости (бэктест‑ядро)

### Основные каталоги
- `src/` — Python‑логика бота
  - `main.py` — точка входа в лайв: проверяет/пересобирает Rust‑расширение и вызывает `passivbot.main()`
  - `passivbot.py` — основная логика лайва: цикл исполнения, выбор монет (forager), управление ордерами/позициями
  - `config_utils.py` — чтение/приведение конфигов к формату v7, шаблоны, CLI‑переопределения
  - `procedures.py` — служебные процедуры: загрузка ключей, коды брокеров, утилиты времени/файлов, получение списка монет
  - `exchanges/` — адаптеры бирж (Bybit/OKX/Bitget/GateIO/Binance/Hyperliquid/KuCoin/DeFX)
  - `backtest.py` — бэктестер: подготовка данных, вызовы Rust‑ядра, анализ результатов
  - `optimize.py` — оптимизатор (DEAP/NSGA‑II), массовые бэктесты, Парето‑фронт
  - `downloader.py` — менеджер OHLCV (загрузка/кеш/соединение источников)
  - `pure_funcs.py`, `njit_*.py` — численные утилиты и Numba‑ускоренные функции
  - `plotting.py`, `interactive_plot.py` — визуализация
- `passivbot-rust/` — Rust‑ядро (в т.ч. алгоритмы бэктеста, трейлинга, типов и утилит)
- `configs/` — готовые и шаблонные конфиги лайва/бэктеста/оптимизации
- `docs/` — документация (включая этот «Handbook»)
- `Dockerfile*`, `docker-compose.yml` — контейнеризация и удобный запуск

### Потоки данных и управление
1) Источники 1m OHLCV подтягиваются/кешируются (через `downloader.py`) и используются для forager‑оценок/бэктеста
2) В лайве `passivbot.py` циклически:
   - обновляет состояния позиций/ордеров
   - фильтрует монеты по спискам/возрасту/мин.размеру/объёму/шумности
   - рассчитывает «идеальные» монеты (forager) и выставляет/переоценивает лимитные ордера
   - соблюдает лимиты WE и применяет unstuck‑процедуры
3) Бэктест/оптимизация используют те же параметры, но исполняются оффлайн (ядро — Rust)

### Событийная петля (live)
Высокоуровнево — «тик» исполнения:
- сбор актуальных данных (позиции, ордера, цены)
- выбор и проверка монет (approved/ignored, возраст, min_cost)
- оценка forager‑метрик (объём/«шумность») и `n_positions` лучших
- выставление/снятие/обновление лимитных ордеров входа/выхода
- проверка лимитов и процедур разгрузки риска (unstuck)

### Где править поведение
- Риск и поведение — через конфиг `configs/*.json` (разделы `bot.*`, `live.*`)
- Глубокие поведенческие изменения — `src/passivbot.py`, `src/pure_funcs.py`, `src/njit_*.py`
- Производительность бэктеста — `passivbot-rust/src/*.rs`

Далее см. остальные главы Handbook для детальной проработки каждой подсистемы.


