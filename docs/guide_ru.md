## Passivbot — подробная документация (RU)

Версия проекта: v7.3.16

Этот документ — практическое руководство по Passivbot: как работает стратегия, какие есть настройки, как запускать бота в лайве, проводить бэктесты и оптимизацию.


## Что такое Passivbot

Passivbot — это крипто-бот-маркетмейкер для бессрочных фьючерсов (perpetuals) на биржах Bybit, OKX, Bitget, GateIO, Binance и Hyperliquid. Он не предсказывает рынок и не использует индикаторы для «угадать тренд». Идея — контртрендовая торговля сеткой лимитных ордеров в обе стороны, чтобы «сдерживать» цену и забирать откаты. Бот может:
- автоматически расставлять/отменять лимитные ордера на вход/выход,
- усреднять позицию (в разумных лимитах риска),
- использовать трейлинг-входы/выходы,
- управлять «застрявшими» позициями через контролируемое закрытие части позиции в небольшой минус (unstuck),
- выбирать более «шумные» рынки для входа (Forager).


## Быстрый старт

1) Установите зависимости

```bash
git clone https://github.com/enarjord/passivbot.git
cd passivbot
python -m venv venv
source venv/Scripts/activate  # Windows (PowerShell) — или venv/bin/activate для Linux/macOS
pip install -r requirements.txt
```

2) Установите Rust (для ускоренного бэктестера)
- Инструкции: `https://www.rust-lang.org/tools/install`
- После установки перезапустите терминал.

3) Создайте файл ключей API

```bash
cp api-keys.json.example api-keys.json
# заполните api-keys.json своими ключами/секретами и именем аккаунта (user)
```

4) Запустите бота c шаблонной конфигурацией или своей

```bash
# по user из api-keys.json
python src/main.py -u <имя_аккаунта>

# по кастомной конфигурации
python src/main.py path/to/config.json
```


## Архитектура и компоненты

- `src/main.py` — управление сборкой Rust-расширений и запуск основного цикла.
- `src/passivbot.py` — бизнес-логика лайв-торговли и взаимодействия с биржами (через адаптеры в `src/exchanges/`).
- `src/backtest.py` — бэктест «фореджера» (мультикорпус), подготовка данных OHLCV, вызов Rust-ядра.
- `src/optimize.py` — оптимизатор параметров (NSGA‑II), массовые бэктесты и выбор Парето-фронта.
- `src/config_utils.py` — загрузка/валидация конфигов, CLI-переопределения, шаблоны (`get_template_live_config`).
- `passivbot-rust/` — вычислительные ядра на Rust (бэктест/логика сеток/трейлинга).


## Как работает стратегия

Идея — «малый первый вход» и усреднение позиции при неблагоприятном движении, чтобы подтягивать среднюю цену позиции ближе к текущей. Выход — сеткой ТП (take-profit) или трейлинговым закрытием на откате. Важные элементы:

- Сетка входов (Grid entries)
  - Начальный вход от EMA‑диапазона и/или фиксированного смещения.
  - Повторные входы (re-entries) ниже/выше текущей средней цены позиции на заданный процентный шаг.
  - Объём усреднения контролируется коэффициентом «double_down_factor».

- Трейлинг-входы/выходы (Trailing)
  - Вместо фиксированных уровней используется «сначала пройти порог, затем откатиться на X%». Это даёт более избирательное взятие откатов.
  - Работает по 1-минутным свечам, трекер пересчитывается каждую полную минуту.

- Forager (динамический выбор рынков)
  - Выбирает более «шумные» (волатильные) инструменты: средняя нормированная амплитуда на 1м свечах, `mean((high - low)/close)`.

- Unstuck (разморозка)
  - Если позиция «застряла» (вплотную к лимиту риска и далеко от цены), бот может дробно закрывать её в небольшой минус, используя прибыль с других позиций, чтобы разгрузить риск.


## Риск-менеджмент кратко

- Wallet Exposure (WE): доля незадолженного баланса, занятого позицией.
  - Формула: `WE = (position_size * position_price) / wallet_balance`
  - Пример: баланс $1000, размер 100, цена 35 → WE = 100*35/1000 = 3.5 (350%).

- Пределы риска задаются через:
  - `total_wallet_exposure_limit` — предел суммарной экспозиции на сторону (long/short).
  - `n_positions` — макс. число одновременно открытых позиций; лимит на одну позицию равен `total_wallet_exposure_limit / n_positions`.

- Леверидж на бирже должен быть не ниже суммы лимитов по сторонам, иначе будут ошибки «insufficient margin». Сам по себе леверидж поведение бота не меняет (бот считает в нелеквидированном балансе).


## Конфигурация: структура и ключевые поля

Конфиг версии v7 содержит секции: `backtest`, `bot`, `live`, `optimize`, `coin_overrides`.
Рекомендуется начать с `configs/template.json` и адаптировать под свои цели.

### Backtest
- `base_dir` — куда сохранять результаты.
- `compress_cache` — сжатие кеша OHLCV на диск.
- `start_date` / `end_date` — период теста (поддерживается `"now"`).
- `exchanges` — список бирж-источников 1m OHLCV (напр. `["binance","bybit"]`).
- `combine_ohlcvs` — если true, объединяет в один массив (иначе тест по биржам отдельно).
- `starting_balance` — стартовый баланс (USD).
- `use_btc_collateral` — бэктест в BTC-коллатерале (прибыль конвертится в BTC; убыток — USD‑долг).
- `gap_tolerance_ohlcvs_minutes` — допустимые разрывы в данных.

Запуск:
```bash
python src/backtest.py [path/to/config.json]  # -dp чтобы отключить построение графиков
```

Результаты сохраняются в `backtests/<exchange>/...` (аналитика, графики, csv).

### Bot: общие параметры (для long и для short)

- EMA‑пояс
  - `ema_span_0`, `ema_span_1` — периоды EMA (в минутах). Третий EMA берётся геометрическим средним. Из них формируются верхняя/нижняя границы «EMA‑band», от которых считаются начальные входы и unstuck‑закрытия.

- Лимиты и включение
  - `n_positions` — макс. число позиций на сторону (0 отключает сторону).
  - `total_wallet_exposure_limit` — суммарный лимит экспозиции на сторону.
  - `enforce_exposure_limit` — строго держать экспозицию в лимите (при превышении — частично сократить маркетом до лимита).

- Сетка входов (Grid entries)
  - `entry_initial_ema_dist` — отступ начального входа от EMA‑пояса (long от нижней, short от верхней границы).
  - `entry_initial_qty_pct` — доля от `balance * WE_limit` на первый вход.
  - `entry_grid_spacing_pct` — базовый шаг для ре‑энтри от средней цены позиции.
  - `entry_grid_spacing_weight` — усиливает/ослабляет шаг в зависимости от текущей заполненности экспозиции.
  - `entry_grid_double_down_factor` — коэффициент умножения размера следующего усреднения.

- Трейлинг (входы и выходы)
  - `trailing_grid_ratio` — доля, которой будет отдан приоритет: >0 сначала трейлинг, <0 сначала сетка, 0 — только сетка, |1| — только трейлинг.
  - `trailing_threshold_pct` — порог, на сколько цена должна пройти в «правильную» сторону прежде, чем включается ожидание отката.
  - `trailing_retracement_pct` — насколько должна откатиться после порога, чтобы сработал ордер.

- Сетка выходов (TP grid)
  - `close_grid_markup_start` / `close_grid_markup_end` — диапазон наценок к средней цене позиции, где ставятся ТП‑ордера.
  - `close_grid_qty_pct` — доля «полного размера» позиции на один ТП ордер.
  - Направление ТП зависит от того, больше ли `start` чем `end` (назад/вперёд).

- Трейлинг‑закрытия
  - `close_trailing_grid_ratio`, `close_trailing_threshold_pct`, `close_trailing_retracement_pct`, `close_trailing_qty_pct` — аналогично трейлинг‑входам.

- Unstuck (разморозка)
  - `unstuck_threshold` — начиная с какого заполнения позиции считать её «застрявшей».
  - `unstuck_close_pct` — какую долю «полного» размера закрывать каждым шагом.
  - `unstuck_ema_dist` — насколько отстоит «авто‑закрытие» от EMA‑пояса.
  - `unstuck_loss_allowance_pct` — сколько от прошлой пиковый балансовой вершины можно допустить просадки (взвешенно на `total_wallet_exposure_limit`).

- Фильтры монет (Forager)
  - `filter_volume_drop_pct` — отфильтровать нижний процент монет по объёму.
  - `filter_noisiness_rolling_window` / `filter_volume_rolling_window` — окна (мин) для расчёта шума/объёма при динамическом выборе монет.

Практические заметки:
- Для старта снизьте `total_wallet_exposure_limit`, ограничьте `n_positions`, и держите `enforce_exposure_limit=true`.
- Трейлинг даёт «умнее» точки, но может входить/выходить реже. Сетка — проще и предсказуемей.

### Live

- Управление списком монет
  - `approved_coins` — список допущенных монет (можно путь к файлу или словарь `{"long":[...],"short":[...]}`); пустой список при `empty_means_all_approved=true` означает «все разрешены».
  - `ignored_coins` — исключённые монеты (также поддерживает разделение long/short и путь к файлу).
  - `auto_gs` — если монета стала недопущенной: перевести позицию в «graceful stop» вместо «manual».

- Торговые параметры
  - `leverage` — леверидж на бирже (должен покрывать суммарную экспозицию, см. риск‑менеджмент).
  - `market_orders_allowed` — разрешать маркет при очень близких ценах вместо лимитов.
  - `max_n_cancellations_per_batch` / `max_n_creations_per_batch` — сколько отмен/созданий ордеров за один тик.
  - `mimic_backtest_1m_delay` — обновлять и переоценивать ордера только раз в полную минуту (для лучшего совпадения с бэктестом).
  - `execution_delay_seconds` — задержка после отправки на биржу.
  - `time_in_force` — политика ордеров (по умолчанию GTC).
  - `price_distance_threshold` — минимальная дистанция до цены для EMA‑ордеров.
  - `pnls_max_lookback_days` — глубина истории PnL.

- Режимы (принудительно)
  - `forced_mode_long` / `forced_mode_short` ∈ {`m` (manual), `gs` (graceful_stop), `t` (tp_only), `p` (panic)}.
  - Значения на монету можно переопределять через `coin_overrides` (см. ниже).

- Пользователь/API
  - `user` — имя записи в `api-keys.json`.

### Coin overrides (переопределения на монету)

Позволяет точечно менять часть настроек для конкретных монет, не дублируя весь конфиг. Пример:

```json
{
  "coin_overrides": {
    "BTC": {
      "bot": {"long": {"close_grid_markup_start": 0.005}},
      "live": {"leverage": 15}
    }
  }
}
```

Также можно подмешать внешний файл через `override_config_path`.

Разрешённые к переопределению ключи:
- В `bot.long/short`: все основные параметры сетки/трейлинга/unstuck/EMA/лимиты экспозиции.
- В `live`: `forced_mode_long`, `forced_mode_short`, `leverage`.

### Optimize (оптимизация параметров)

- Алгоритм: NSGA‑II (мульти‑цели), поддержка Парето‑фронта, штрафы за выход за лимиты.
- Ключи:
  - `bounds` — диапазоны для всех оптимизируемых параметров.
  - `scoring` — целевые метрики (например, `adg`, `sharpe_ratio`; префикс `btc_` — метрики в BTC‑коллатерале).
  - `limits` — пороговые ограничения: `penalize_if_greater_than_<metric>` или `penalize_if_lower_than_<metric>`.
  - `n_cpus`, `population_size`, `iters`, `crossover_probability`, `mutation_probability` — настройки генетического алгоритма.

Запуск:
```bash
python src/optimize.py [path/to/config.json] \
  --start path/to/dir_or_file_with_configs  # опционально, стартовый пул
```

Вывод:
- Папка `optimize_results/<дата>_<биржи>_<дней>_<коины>_<хэш>/` с `all_results.bin` и каталогом `pareto/` (лучшие решения с расстоянием до идеала в имени файла).
- Визуализация Парето:

```bash
python src/pareto_store.py optimize_results/.../pareto/
```


## Практические рекомендации

- Начинайте с малого риска: уменьшите `total_wallet_exposure_limit`, установите `n_positions` в 1–3, держите `enforce_exposure_limit=true`.
- Разрешите только лимитные ордера (`market_orders_allowed=false`), если опасаетесь проскальзывания.
- Следите за `minimum_coin_age_days` и фильтрами Forager, чтобы не торговать «свежим» неликвидом.
- Для сопоставимости бэктеста и лайва используйте `mimic_backtest_1m_delay=true`.
- Подбирайте `close_grid_markup_*` так, чтобы первые ТП не были слишком близко — иначе частые мелкие закрытия, но растут комиссии.
- Используйте оптимизатор для нахождения базовых диапазонов, затем сузьте настройки вручную под ваш риск-профиль.


## Частые вопросы

- «Почему меняется леверидж на бирже, а риск/поведение не меняются?»
  - Бот считает риск в нелеквидированном балансе, леверидж нужен лишь как техническая «крыша» для маржи. Важны именно лимиты экспозиции.

- «Что значит `trailing_grid_ratio`?»
  - Задаёт, какой частью позиции пользоваться трейлингом и в каком порядке. `1.0` — только трейлинг, `0.0` — только сетка, `0.3` — сначала трейлинг до 30% позиции, затем сетка.

- «Как работает `unstuck_loss_allowance_pct`?»
  - Определяет допуск просадки относительно прошлой пиковый кривой баланса (с масштабированием на суммарную экспозицию). Бот не будет бесконтрольно «резать» позиции.


## Примеры команд

Лайв:
```bash
python src/main.py -u bybit_01
python src/main.py configs/my_config.json
```

Бэктест:
```bash
python src/backtest.py
python src/backtest.py configs/my_config.json -dp
```

Оптимизация:
```bash
python src/optimize.py configs/my_config.json --start configs/examples/
```


## Полезные файлы и каталоги

- `configs/template.json` — эталонная структура конфига v7.
- `configs/examples/` — готовые примеры (один инструмент, множественные и т.п.).
- `docs/` — доп. документы: backtesting, optimizing, risk_management, и др.
- `src/exchanges/` — биржевые адаптеры (Binance, Bybit, OKX, Bitget, GateIO, Hyperliquid, KuCoin, DeFX).


## Дисклеймер

Торговля фьючерсами рискованна. Используйте бота на свой страх и риск. Сначала тестируйте на небольших суммах и на истории. Разработчики не несут ответственности за возможные убытки.


