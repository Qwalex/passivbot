# Объяснение параметров Passivbot

Этот документ предоставляет обзор параметров, найденных в `config/template.json`.

## Настройки бэктестинга

- **base_dir**: Место для сохранения результатов бэктестинга.
- **compress_cache**: Установите `true` для экономии места на диске. Установите `false` для более быстрой загрузки.
- **end_date**: Дата окончания бэктестинга, например, `2024-06-23`. Установите `'now'` для использования сегодняшней даты как даты окончания.
- **exchanges**: Биржи, с которых получать 1-минутные OHLCV данные для бэктестинга и оптимизации. Варианты: `[binance, bybit, gateio, bitget]`.
- **start_date**: Дата начала бэктестинга.
- **starting_balance**: Начальный баланс в USD в начале бэктестинга.
- **use_btc_collateral**: `true`/`false`. Установите `true` для бэктестинга с BTC в качестве залога, симулируя начало с 100% BTC и покупку BTC на все USD прибыли, но не продажу BTC при убытках (вместо этого уходим в USD долг).
  - Пример: При цене BTC/USD `$100,000`, если баланс BTC составляет `1.0` и бэктестер получает прибыль `$10`, баланс BTC становится `1.0001`, а баланс USD становится `0`. Если бэктестер теряет `$20`, баланс BTC остается `1.0001`, а баланс USD становится `-20`. Если бэктестер затем получает прибыль `$15`, сначала погашается USD долг: баланс BTC остается `1.0001`, баланс USD становится `-5`. Если бэктестер затем получает прибыль `$10`: баланс BTC становится `1.00015`, баланс USD становится `0`.

## Настройки бота

### Общие параметры для длинных и коротких позиций

- **ema_span_0**, **ema_span_1**:
  - Периоды даны в минутах.
  - Формула: `next_EMA = prev_EMA * (1 - alpha) + new_val * alpha`, где `alpha = 2 / (span + 1)`.
  - Дополнительный период EMA рассчитывается как `(ema_span_0 * ema_span_1)**0.5`.
  - Три EMA формируют верхнюю и нижнюю EMA полосы:
    - `ema_band_lower = min(emas)`
    - `ema_band_upper = max(emas)`
  - Эти полосы используются для начальных входов и автоматических закрытий "застрявших" позиций.
- **n_positions**: Максимальное количество позиций для открытия. Установите `0` для отключения длинных/коротких позиций.
- **total_wallet_exposure_limit**: Максимально допустимая экспозиция.
  - Пример: `total_wallet_exposure_limit = 0.75` означает, что используется 75% (неплечевого) баланса кошелька.
  - Пример: `total_wallet_exposure_limit = 1.6` означает, что используется 160% (неплечевого) баланса кошелька.
  - Каждая позиция получает равную долю: `wallet_exposure_limit = total_wallet_exposure_limit / n_positions`.
  - Подробнее см.: `docs/risk_management.md`.
- **enforce_exposure_limit**: Если `true`, принудительно соблюдает лимиты экспозиции для каждой позиции.
  - Пример: Если экспозиция позиции превышает 1% от лимита, уменьшите позицию по рыночной цене до лимита экспозиции.
  - Полезно для управления рисками, например, если пользователь выводит баланс или изменяет настройки.

### Параметры сетки входов

Passivbot может быть настроен для создания сетки входных ордеров с ценами и количествами, определяемыми следующими параметрами:

- **entry_grid_double_down_factor**:
  - Количество следующего входа в сетке равно размеру позиции, умноженному на фактор удвоения.
  - Пример: Если размер позиции составляет `1.4`, а `double_down_factor` равен `0.9`, то количество следующего входа составляет `1.4 * 0.9 = 1.26`.
  - Также применяется к трейлинг входам.
- **entry_grid_spacing_pct**, **entry_grid_spacing_weight**:
  - Цены повторного входа в сетке определяются следующим образом:
    - `next_reentry_price_long = pos_price * (1 - entry_grid_spacing_pct * modifier)`
    - `next_reentry_price_short = pos_price * (1 + entry_grid_spacing_pct * modifier)`
  - Где `modifier = (1 + ratio * entry_grid_spacing_weight)` и `ratio = wallet_exposure / wallet_exposure_limit`.
- **entry_initial_ema_dist**:
  - Смещение от нижней/верхней EMA полосы.
  - Цены начального входа длинной позиции/закрытия короткой "застрявшей" позиции равны нижней EMA полосе минус смещение.
  - Цены начального входа короткой позиции/закрытия длинной "застрявшей" позиции равны верхней EMA полосе плюс смещение.
  - См. `ema_span_0`/`ema_span_1`.
- **entry_initial_qty_pct**:
  - `initial_entry_cost = balance * wallet_exposure_limit * initial_qty_pct`

### Параметры трейлинга

Та же логика применяется как к трейлинг входам, так и к трейлинг закрытиям.

- **trailing_grid_ratio**:
  - Устанавливает распределение трейлинг и сеточных ордеров.
  - Если `trailing_grid_ratio = 0.0`, только сеточные ордера.
  - Если `trailing_grid_ratio = 1.0` или `trailing_grid_ratio = -1.0`, только трейлинг ордера.
  - Если `trailing_grid_ratio > 0.0`, сначала трейлинг ордера, затем сеточные ордера.
  - Если `trailing_grid_ratio < 0.0`, сначала сеточные ордера, затем трейлинг ордера.
    - Пример: `trailing_grid_ratio = 0.3`: Трейлинг ордера до тех пор, пока позиция не заполнится на 30%, затем сеточные ордера для остального.
    - Пример: `trailing_grid_ratio = -0.9`: Сеточные ордера до тех пор, пока позиция не заполнится на `(1 - 0.9) = 10%`, затем трейлинг ордера для остального.
    - Пример: `trailing_grid_ratio = -0.12`: Сеточные ордера до тех пор, пока позиция не заполнится на `(1 - 0.12) = 88%`, затем трейлинг ордера для остального.
- **trailing_retracement_pct**, **trailing_threshold_pct**:
  - Два условия запускают трейлинг ордер: 1) порог и 2) откат.
  - Если `trailing_threshold_pct <= 0.0`, условие порога всегда срабатывает.
  - Для длинных позиций:
    - `if highest price since position change > position price * (1 + trailing_threshold_pct)`, первое условие выполнено.
    - `if lowest price since highest price < highest price since position change * (1 - trailing_retracement_pct)`, второе условие выполнено. Разместить ордер.
  - Passivbot отслеживает свои собственные трейлинг цены и не использует специальные типы трейлинг ордеров от биржи.
  - Трекер трейлинг цены сбрасывается при изменении позиции (добавление или частичное закрытие).
  - Отслеживание трейлинг цены основано на 1-минутных OHLCV, обновляется каждую новую полную минуту.

### Параметры сетки закрытия

- **close_grid_markup_start**, **close_grid_markup_end**, **close_grid_qty_pct**:
  - Цены Take Profit (TP) линейно распределены между:
    - `pos_price * (1 + markup_start)` до `pos_price * (1 + markup_end)` для **длинных** позиций.
    - `pos_price * (1 - markup_start)` до `pos_price * (1 - markup_end)` для **коротких** позиций.
  - Направление TP зависит от относительных значений `markup_start` и `markup_end`:
    - Если `markup_start > markup_end`: TP сетка строится **назад** (начиная с более высокой цены и убывая для длинных / возрастая для коротких).
    - Если `markup_start < markup_end`: TP сетка строится **вперед** (начиная с более низкой цены и возрастая для длинных / убывая для коротких).
  - Пример (**длинная** позиция, обратный TP): Если `pos_price = 100`, `markup_start = 0.01`, `markup_end = 0.005`, и `close_grid_qty_pct = 0.2`, TP цены: `[101.0, 100.9, 100.8, 100.7, 100.6]`.
  - Пример (**длинная** позиция, прямой TP): Если `markup_start = 0.005`, `markup_end = 0.01`, TP цены: `[100.5, 100.6, 100.7, 100.8, 100.9]`.
  - Пример (**короткая** позиция, прямой TP): Если `pos_price = 100`, `markup_start = 0.005`, `markup_end = 0.01`, TP цены: `[99.5, 99.4, 99.3, 99.2, 99.1]`.
  - Пример (**короткая** позиция, обратный TP): Если `markup_start = 0.01`, `markup_end = 0.005`, TP цены: `[99.0, 99.1, 99.2, 99.3, 99.4]`.
  - Количество на ордер равно `full pos size * close_grid_qty_pct`.
  - Примечание: Полный размер позиции относится к максимальному размеру. Если фактическая позиция меньше, может быть создано меньше ордеров, чем `1 / close_grid_qty_pct`.
  - TP сетка заполняется по порядку от `markup_start` до `markup_end`, распределяя каждый срез до соответствующего количества:
    - Первый TP до `close_grid_qty_pct * full_pos_size`.
    - Второй TP от `close_grid_qty_pct` до `2 * close_grid_qty_pct`, и т.д.
  - Пример: Если `full_pos_size = 100` и `long_pos_size = 55`, и цены строятся назад, то TP ордера могут быть `[15@100.8, 20@100.9, 20@101.0]`.
  - Если позиция превышает полный размер позиции, избыточный размер добавляется к TP ордеру, ближайшему к `markup_start`.
    - Пример: Если `long_pos_size = 130` и сетка прямая, TP ордера: `[50@100.5, 20@100.6, 20@100.7, 20@100.8, 20@100.9]`.

### Параметры трейлинг закрытия

- **close_trailing_grid_ratio**: См. Параметры трейлинга выше.
- **close_trailing_qty_pct**: Количество закрытия равно `full pos size * close_trailing_qty_pct`.
- **close_trailing_retracement_pct**: См. Параметры трейлинга выше.
- **close_trailing_threshold_pct**: См. Параметры трейлинга выше.

### Параметры "расклинивания"

Если позиция "застряла", бот использует прибыль от других позиций для реализации убытков по "застрявшей" позиции. Если несколько позиций "застряли", выбирается позиция с наименьшим расстоянием ценового действия для "расклинивания".

- **unstuck_close_pct**:
  - Процент от `full pos size * wallet_exposure_limit` для закрытия каждым ордером "расклинивания".
- **unstuck_ema_dist**:
  - Расстояние от EMA полосы для размещения ордера "расклинивания":
    - `long_unstuck_close_price = upper_EMA_band * (1 + unstuck_ema_dist)`
    - `short_unstuck_close_price = lower_EMA_band * (1 - unstuck_ema_dist)`
- **unstuck_loss_allowance_pct**:
  - Взвешенный процент ниже прошлого пикового баланса для допуска убытков.
  - `loss_allowance = past_peak_balance * (1 - unstuck_loss_allowance_pct * total_wallet_exposure_limit)`
  - Пример: Если прошлый пиковый баланс составлял `$10,000`, `unstuck_loss_allowance_pct = 0.02`, и `total_wallet_exposure_limit = 1.5`, бот прекращает принимать убытки, когда баланс достигает `$10,000 * (1 - 0.02 * 1.5) = $9,700`.
- **unstuck_threshold**:
  - Если позиция больше порога, считайте её "застрявшей" и активируйте "расклинивание".
  - `if wallet_exposure / wallet_exposure_limit > unstuck_threshold: unstucking enabled`
  - Пример: Если размер позиции составляет `$500`, а максимально допустимый размер позиции составляет `$1000`, позиция заполнена на 50%. Если `unstuck_threshold = 0.45`, "расклинивайте" позицию до тех пор, пока её размер не станет `$450`.

### Параметры фильтрации

Монеты, выбранные для торговли, фильтруются по объему и "шумности". Сначала фильтруются монеты по объему, отбрасывая процент монет с наименьшим объемом. Затем сортируются подходящие монеты по "шумности" и выбираются топ-самые "шумные" монеты для торговли.

- **filter_volume_drop_pct**: Фильтр объема. Отклоняет монеты с наименьшим относительным объемом.
  - Пример: `filter_volume_drop_pct = 0.1` отбрасывает 10% монет с наименьшим объемом. Установите `0` для разрешения всех.
- **filter_noisiness_rolling_window/filter_volume_rolling_window**: Количество минут для просмотра в прошлое для вычисления объема и "шумности", используется для динамического выбора монет в режиме "forager".
  - "Шумность" - это нормализованный относительный диапазон 1-минутных OHLCV: `mean((high - low) / close)`.
  - В режиме "forager" бот выбирает монеты с наивысшей "шумностью" для открытия позиций.

## Переопределения монет
- **coin_overrides**:
  - Укажите полные или частичные конфигурации для отдельных монет, переопределяя значения из основной конфигурации.
  - Формат: {"COIN1": overrides1, "COIN2": overrides2}
  - Полные конфигурации могут быть загружены с параметром "override_config_path". Может быть либо полный путь к конфигурации, либо имя файла альтернативной конфигурации из той же директории, что и основной файл конфигурации.
  - Специфические параметры переопределения имеют приоритет над параметрами переопределения, загруженными из внешней конфигурации.
  - Только подмножество параметров конфигурации подходит для переопределения основной конфигурации:
    - config.bot.long/short:
      ```
      [
        close_grid_markup_end, close_grid_markup_start, close_grid_qty_pct, close_trailing_grid_ratio, close_trailing_qty_pct,
        close_trailing_retracement_pct, close_trailing_threshold_pct, ema_span_0, ema_span_1, enforce_exposure_limit,
        entry_grid_double_down_factor, entry_grid_spacing_pct, entry_grid_spacing_weight, entry_initial_ema_dist,
        entry_initial_qty_pct, entry_trailing_double_down_factor, entry_trailing_grid_ratio, entry_trailing_retracement_pct,
        entry_trailing_threshold_pct, unstuck_close_pct, unstuck_ema_dist, unstuck_threshold, wallet_exposure_limit
      ]
      ```
    -config.live:
    ```
    [forced_mode_long, forced_mode_short, leverage]
    ```
  - Примеры:
    - `{"COIN1": {"override_config_path": "path/to/override_config.json"}}` -- Попытается загрузить "path/to/override_config.json" и применить все подходящие параметры оттуда для COIN1
    - `{"COIN2": {"override_config_path": "path/to/other_override_config.json", {"bot": {"long": {"close_grid_markup_start": 0.005}}}}}` -- Попытается загрузить `"path/to/other_override_config.json"` сначала, и применить `{"bot": {"long": {"close_grid_markup_start": 0.005}}}` после.
    - `{"COIN3": {"bot": {"short": {"entry_initial_qty_pct": 0.01}}, "live": {"forced_mode_long": "panic"}}}` -- Применит данные переопределения для COIN3.
- **forced_modes**:
  - Выбор: `[n (normal), m (manual), gs (graceful_stop), t (tp_only), p (panic)]`.
    - **Обычный режим**: Passivbot управляет позицию как обычно.
    - **Ручной режим**: Passivbot игнорирует позицию.
    - **Плавная остановка**: Если есть позиция, Passivbot управляет ею; в противном случае новые позиции не открываются.
    - **Режим только Take Profit**: Passivbot управляет только закрывающими ордерами.
    - **Панический режим**: Passivbot немедленно закрывает позицию.

## Настройки живой торговли

- **approved_coins**:
  - Список монет, одобренных для торговли. Если пустой, см. `live.empty_means_all_approved`.
    - Бэктестер и оптимизатор используют `live.approved_coins` минус `live.ignored_coins`.
  - Может быть указан как путь к внешнему файлу, непрерывно читаемому Passivbot.
  - Может быть разделен на длинные и короткие:
    - Пример: `{"long": ["COIN1", "COIN2"], "short": ["COIN2", "COIN3"]}`
- **auto_gs**: Автоматически включать плавную остановку для позиций на неодобренных монетах.
  - Плавная остановка: Бот продолжает торговать как обычно, но не открывает новую позицию после полного закрытия текущей позиции.
  - Если `auto_gs=false`, позиции на неодобренных монетах переводятся в ручной режим.
- **empty_means_all_approved**:
  - Если `true`, `approved_coins=[]` означает, что все монеты одобрены.
  - Если `false`, `approved_coins=[]` означает, что ни одна монета не одобрена.
- **execution_delay_seconds**: Ждать `x` секунд после выполнения на биржу.
- **filter_by_min_effective_cost**: Если `true`, запрещает монеты, где `balance * WE_limit * initial_qty_pct < min_effective_cost`.
  - Пример: Если минимальная эффективная стоимость биржи для монеты составляет `$5`, но бот хочет сделать ордер на `$2`, запретить эту монету.
- **forced_mode_long**, **forced_mode_short**: Принудительно перевести все длинные/короткие монеты в заданный режим.
  - Выбор: `[m (manual), gs (graceful_stop), p (panic), t (take_profit_only)]`.
- **ignored_coins**:
  - Список монет, на которых бот не будет создавать позиции. Если есть позиции на этой монете, включить плавную остановку или ручной режим.
  - Может быть указан как путь к внешнему файлу, непрерывно читаемому Passivbot.
  - Может быть разделен на длинные и короткие:
    - Пример: `{"long": ["COIN1", "COIN2"], "short": ["COIN2", "COIN3"]}`
- **leverage**: Плечо, установленное на бирже. По умолчанию `10`.
- **market_orders_allowed**: Если `true`, позволяет Passivbot размещать рыночные ордера, когда цена ордера очень близка к текущей рыночной цене. Если `false`, размещает только лимитные ордера. По умолчанию `true`.
- **max_n_cancellations_per_batch**: Отменяет `n` открытых ордеров за выполнение.
- **max_n_creations_per_batch**: Создает `n` новых ордеров за выполнение.
- **max_n_restarts_per_day**: Если бот падает, перезапускаться до `n` раз в день перед полной остановкой.
- **mimic_backtest_1m_delay**: Если `true`, бот будет обновлять и оценивать открытые ордера только раз в полную минуту, синхронизированно с часами (например, 12:01:00, 12:02:00 и т.д.). Это имитирует логику временных шагов бэктестера и избегает внутриминутных обновлений. Полезно для достижения более высокой точности между бэктестом и живой производительностью.
- **minimum_coin_age_days**: Запрещает монеты моложе заданного количества дней.
- **ohlcvs_1m_rolling_window_days**: Сколько дней OHLCV бот держит в памяти. Уменьшите, если потребление RAM является проблемой.
- **ohlcvs_1m_update_after_minutes**: Насколько старыми могут быть OHLCV для монеты перед получением свежих с биржи. Увеличьте, если ограничение скорости является проблемой.
- **pnls_max_lookback_days**: Насколько далеко в прошлое получать историю PnL.
- **price_distance_threshold**: Минимальное расстояние до текущего ценового действия, необходимое для EMA-основанных лимитных ордеров.
- **time_in_force**: По умолчанию Good-Till-Cancelled.
- **user**: Получить API ключ/секрет из `api-keys.json`.

## Настройки оптимизации

### Границы

При оптимизации значения параметров находятся в пределах нижней и верхней границ.

### Другие параметры оптимизации

- **compress_results_file**: Если `true`, сжимает файл результатов оптимизации для экономии места.
- **enable_overrides**: Список пользовательских переопределений оптимизатора для включения. Используйте `optimizer_overrides.py` для переопределений. По умолчанию нет.
- **crossover_probability**: Вероятность выполнения скрещивания между двумя особями в генетическом алгоритме. Определяет, как часто родители обмениваются генетической информацией для создания потомства.
- **iters**: Количество бэктестов за сессию оптимизации.
- **mutation_probability**: Вероятность мутации особи в генетическом алгоритме. Определяет, как часто вносятся случайные изменения для поддержания разнообразия.
- **n_cpus**: Количество ядер CPU, используемых параллельно.
- **population_size**: Размер популяции для генетического алгоритма оптимизации.
- **scoring**:
  - Оптимизатор использует две цели и находит фронт Парето.
  - Выбирает оптимального кандидата на основе наименьшего евклидова расстояния до идеальной точки.
  - Значения по умолчанию - медианный дневной прирост и коэффициент Шарпа.
  - Использует алгоритм NSGA-II (Non-dominated Sorting Genetic Algorithm II) для многоцелевой оптимизации.
  - Функция пригодности минимизирует обе цели (внутренне преобразованные в отрицательные значения).
  - Полный список опций: `[adg, adg_w, calmar_ratio, calmar_ratio_w, drawdown_worst, drawdown_worst_mean_1pct, equity_balance_diff_neg_max, equity_balance_diff_neg_mean, equity_balance_diff_pos_max, equity_balance_diff_pos_mean, expected_shortfall_1pct, gain, loss_profit_ratio, loss_profit_ratio_w, mdg, mdg_w, omega_ratio, omega_ratio_w, position_held_hours_max, position_held_hours_mean, position_held_hours_median, position_unchanged_hours_max, positions_held_per_day, sharpe_ratio, sharpe_ratio_w, sortino_ratio, sortino_ratio_w, sterling_ratio, sterling_ratio_w]`
  - Суффикс `_w` указывает среднее значение по 10 временным подмножествам (целое, последняя_половина, последняя_треть, ..., последняя_десятая) для более тяжелого взвешивания недавних данных.
  - Примеры: `["mdg", "sharpe_ratio", "loss_profit_ratio"]`, `["adg", "sortino_ratio", "drawdown_worst"]`, `["sortino_ratio", "omega_ratio", "adg_w", "position_unchanged_hours_max"]`
    - Примечание: если config.backtest.use_btc_collateral=True, добавьте префикс "btc_" для использования метрик в BTC, например btc_adg или btc_drawdown_worst.

### Ограничения оптимизации

Оптимизатор штрафует бэктесты, чьи значения метрик превышают или не достигают указанных порогов. Штрафы добавляются к оценке пригодности для отговорить от нежелательных конфигураций, но не дисквалифицируют конфигурацию.

#### Формат

Ограничения могут быть установлены в файле конфигурации под `optimize.limits` или переданы через CLI с помощью `--limits`.

##### Пример конфигурации

```json
"limits": {
  "penalize_if_greater_than_drawdown_worst": 0.3,
  "penalize_if_lower_than_adg": 0.001
}
```

##### Пример CLI аргумента:

```
python3 src/optimize.py --limits "--penalize_if_lower_than_btc_omega_ratio 3.0 --penalize_if_greater_than_loss_profit_ratio 0.5"
```
