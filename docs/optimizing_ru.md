# Оптимизация

Конфигурации Passivbot могут быть оптимизированы с использованием многоцелевого эволюционного алгоритма для балансировки метрик производительности при соблюдении ограничений.

## Запуск оптимизации

```bash
python3 src/optimize.py [path/to/config.json]
```

- По умолчанию использует `configs/template.json`, если конфигурация не указана
- Используйте существующие конфигурации как отправные точки: `--start path/to/config(s)`

Пример:
```bash
python3 src/optimize.py configs/template.json --start configs/starting_pool/
```

Большинство параметров конфигурации можно изменить через CLI. `python3 src/optimize.py -h` для получения дополнительной информации.

## Процесс оптимизации

- Использует генетический алгоритм NSGA-II для эволюции конфигураций
- Бэктестирует на исторических OHLCV данных
- Использует многопроцессорность с общей памятью для снижения нагрузки на RAM
- Поддерживает фронт Парето лучших конфигураций
- Принудительно соблюдает ограничения через `optimize.limits`
- Оптимизирует для нескольких метрик через `optimize.scoring`
- Избегает дубликатов через отслеживание хешей и возмущения

## Структура вывода

Каждый запуск оптимизации создает директорию:
```
optimize_results/YYYY-MM-DDTHH_MM_SS_{exchanges}_{n_days}days_{coin_label}_{hash}/
```

Содержимое:
- `all_results.bin`: Бинарный лог всех оцененных конфигураций (формат msgpack)
- `pareto/`: JSON файлы для Парето-оптимальных конфигураций
  - Названы `{distance}_{hash}.json`, где `distance` - нормализованное расстояние до идеальной точки
- `index.json`: Список хешей членов Парето

## Анализ результатов

Полный анализ включен в каждого члена фронта Парето. Используйте
```bash
python3 src/pareto_store.py optimize_results/.../pareto/
```
для создания визуализации. Поддерживает построение графиков для 2 или 3 метрик.

## Ограничения оптимизации

Для принудительного соблюдения ограничений во время оптимизации используйте ключ `optimize.limits`. Каждое ограничение определяет порог, за пределы которого конфигурация будет оштрафована. Штраф растет с серьезностью нарушения. Поддерживаются форматы CLI и файла конфигурации.

### Формат CLI:
Пример:
```bash
--limits "--penalize_if_greater_than_drawdown_worst 0.3 --penalize_if_lower_than_adg 0.001"
```

Это будет:
- Штрафовать любую конфигурацию, где `drawdown_worst > 0.3`
- Штрафовать любую конфигурацию, где `adg < 0.001`

### Формат конфигурации:
```json
"limits": {
  "penalize_if_greater_than_drawdown_worst": 0.3,
  "penalize_if_lower_than_adg": 0.001
}
```

### Примечания:
- Если ключ ограничения просто `metric_name`, направление будет выведено из его веса оценки.
- Названия метрик могут быть либо простыми (например, `adg` для бэктеста с USD залогом), либо с префиксом "\_btc" (например, `btc_adg` для бэктеста с BTC залогом).
- Штрафы применяются к объективной оценке; они не дисквалифицируют конфигурацию.
- Величины штрафов экспоненциально масштабируются, но ограничены для поддержания стабильности.

## Метрики производительности

### Доходность и рост
| Метрика | Описание |
|---------|----------|
| `adg` | Средний дневной прирост (сглаженный геометрический) |
| `mdg` | Медианный дневной прирост |
| `gain` | Итоговый прирост баланса (отношение конечного/начального баланса) |

### Метрики риска
| Метрика | Описание |
|---------|----------|
| `drawdown_worst` | Максимальная просадка от пика до впадины |
| `drawdown_worst_mean_1pct` | Среднее значение худших 1% просадок |
| `expected_shortfall_1pct` | Среднее значение худших 1% дневных убытков (CVaR) |
| `equity_balance_diff_neg_max` | Максимальная отрицательная разность капитала и баланса |
| `equity_balance_diff_neg_mean` | Средняя отрицательная разность капитала и баланса |
| `equity_balance_diff_pos_max` | Максимальная положительная разность капитала и баланса |
| `equity_balance_diff_pos_mean` | Средняя положительная разность капитала и баланса |

### Коэффициенты и эффективность
| Метрика | Описание |
|---------|----------|
| `sharpe_ratio` | Доходность к волатильности |
| `sortino_ratio` | Доходность к нисходящей волатильности |
| `calmar_ratio` | Доходность к максимальной просадке |
| `sterling_ratio` | Доходность к средним 1% худшим просадкам |
| `omega_ratio` | `sum(pos_returns) / sum(abs(neg_returns))`, где returns - дневные процентные изменения капитала |

### Метрики позиций
| Метрика | Описание |
|---------|----------|
| `positions_held_per_day` | Среднее количество позиций, удерживаемых ежедневно |
| `position_held_hours_max` | Максимальная продолжительность любой позиции (часы) |
| `position_held_hours_mean` | Средняя продолжительность позиции (часы) |
| `position_held_hours_median` | Медианная продолжительность позиции (часы) |
| `position_unchanged_hours_max` | Максимальное время между корректировками позиции (часы) |

### Качество кривой капитала
| Метрика | Описание |
|---------|----------|
| `equity_choppiness` | Нормализованная общая вариация (ниже = более гладкая) |
| `equity_jerkiness` | Нормализованная средняя абсолютная вторая производная |
| `exponential_fit_error` | MSE от логарифмически-линейной подгонки (ниже = более последовательный рост) |

> Метрики с суффиксом \_w используют взвешенные по недавности средние значения по нескольким временным срезам.
Конкретно, каждая метрика \_w вычисляется как среднее значение метрики, оцененной по 10 перекрывающимся подмножествам кривой капитала: весь период, последняя 1/2, последняя 1/3, ..., до последней 1/10. Это подчеркивает недавнюю производительность, но все еще учитывает долгосрочное поведение.

## Утилиты

Загрузка результатов программно:
```python
from opt_utils import load_results

for config in load_results("optimize_results/.../all_results.bin"):
    # Работа с конфигурацией
```
